#!/usr/bin/env zsh
# Executes commands at the start of an interactive session.
		
zmodload zsh/zprof
local zshrc_start=$(gdate +%s%N)

# export NVM_DIR="$HOME/.nvm"
# [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" # This loads nvm
# Source Prezto.
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi


# Init rbenv
eval "$(rbenv init -)"

# Fuzzy Completions
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

fpath=(
  /usr/local/share/zsh-completions
  "$fpath[@]"
)

# gulp
eval "$(gulp --completion=zsh)"

# Personalizations
alias rhelp=run-help
alias gi='grep -i'
export CLICOLOR=xterm-color
export PIP_FORMAT=columns
alias yt=youtube-dl
alias yta='youtube-dl -x --audio-format best --audio-quality 0'
alias ytv='youtube-dl --output /Volumes/attic/YouTube\ Video\ Library/%(title)s.%(etc)s'
alias ytp='youtube-dl --output /Volumes/attic/electronics/%(title)s.%(etc)s'
alias openssl-brew='/usr/local/opt/openssl/bin/openssl'
brewO() {brewI --json=v1 "$1" |jq -j '.[]| .installed[-1].used_options | join(" ")'}
brewI2C() {
  local installed=(${(Fo)$(brewO "$1")#*with-})
  local current=("${(f)$(brew options "$1" | sed -E -e '/^--with-/!d' -e 's/^--with-(.*)/\1/')}")
  /usr/bin/diff =(print -l -- $installed) =(print -l -- $current)
}

# zmodload for modules with parameters
zmodload -F zsh/stat b:zstat

# iTerm2 shell integration hooks
source ~/.iterm2_shell_integration.zsh

# Node version manager
# place this after nvm initialization!
autoload -U add-zsh-hook
load-nvmrc() {
  local node_version="$(nvm version)"
  local nvmrc_path="$(nvm_find_nvmrc)"

  if [ -n "$nvmrc_path" ]; then
    local nvmrc_node_version=$(nvm version "$(cat "${nvmrc_path}")")

    if [ "$nvmrc_node_version" != "N/A" ] && [ "$nvmrc_node_version" != "$node_version" ]; then
      nvm install
    fi
  elif [ "$node_version" != "$(nvm version default)" ]; then
    echo "Reverting to nvm default version"
    nvm use default
  fi
}
add-zsh-hook chpwd load-nvmrc
load-nvmrc
gdate "+s%N"

# # Node version manager
 export NVM_LAZY_LOAD=true
 source "/Users/ryan/.nvm/zsh-nvm/zsh-nvm.plugin.zsh"

# perl : By default non-brewed cpan modules are installed to the Cellar. If you wish for your modules to persist across updates we recommend using `local::lib`.
# PERL_MM_OPT="INSTALL_BASE=$HOME/perl5" cpan local::lib
eval "$(perl -I$HOME/perl5/lib/perl5 -Mlocal::lib)"

# pip zsh completion start
function _pip_completion {
  local words cword
  read -Ac words
  read -cn cword
  reply=( $( COMP_WORDS="$words[*]" \
             COMP_CWORD=$(( cword-1 )) \
             PIP_AUTO_COMPLETE=1 $words[1] ) )
}
compctl -K _pip_completion pip
# pip zsh completion end

# Lunchy completion integration
LUNCHY_DIR=$(dirname `gem which lunchy`)/../extras
  if [ -f $LUNCHY_DIR/lunchy-completion.zsh ]; then
    . $LUNCHY_DIR/lunchy-completion.zsh
  fi

alias pip-upgrade-all="pip freeze --local | grep -v '^\-e' | cut -d = -f 1  | xargs -n1 pip install -U"
# alias pip-upgrade-all='pip freeze --local | grep -v '^\-e' | cut -d = -f 1  | xargs -n1 pip install -U'
alias pip3-upgrade-all='pip3 freeze --local | grep -v '^\-e' | cut -d = -f 1  | xargs -n1 pip install -U'

# rbenv init (path & completions)
if [ -f ${RBENV_DIR:-$HOME/.rbenv} ]; then
  path=("${RBENV_DIR:-$HOME/.rbenv}" "$path[@]")
fi

# added by travis gem
[ -f /Users/ryan/.travis/travis.sh ] && source /Users/ryan/.travis/travis.sh

# Initialize Perlbrew
source ~/perl5/perlbrew/etc/bashrc
# Custom function to allow command to run with default macOS system perl environment
alias macperl="env $(print -- '-u '"${(f)^$(env |gi -o "^PERL.*" |cut -d= -f1)}") PATH=$(print -- ${(j%:%)${(s%:%)PATH}:#*perl*}) $*"

# calculate zshrc load end time
local zshrc_end=$(gdate +%s%N)
function calc () {
  bc -l <<< "$@"
}
if [[ -o login ]]; then
  print "~/.zshrc loaded:" $(calc "scale=3;($zshrc_end-$zshrc_start)/10^(9)") "seconds"
fi
unset zshrc_end
unset zshrc_start
